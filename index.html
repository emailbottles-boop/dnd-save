<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractured Sky VTT v4.0 - FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Keep all existing styles - truncated for space */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0e1a; --bg-card: #151928; --bg-hover: #1f2537;
            --accent: #8b5cf6; --accent-secondary: #ec4899; --gold: #fbbf24;
            --text: #e5e7eb; --text-dim: #9ca3af; --border: rgba(139, 92, 246, 0.2);
            --success: #10b981; --danger: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); overflow: hidden; height: 100vh; user-select: none; }
        
        /* Existing styles - keeping original but adding critical ones */
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: relative; z-index: 100; }
        .title { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--gold), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { padding: 0.6rem 1.2rem; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; font-family: 'Inter', sans-serif; }
        .btn:hover { background: var(--accent); border-color: var(--accent); transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); border: none; color: white; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-success { background: var(--success); border-color: var(--success); color: white; }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
        .welcome-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.5s; }
        .welcome-screen.hidden { opacity: 0; pointer-events: none; }
        .welcome-content { text-align: center; padding: 3rem; }
        .welcome-title { font-family: 'Cinzel', serif; font-size: 4rem; font-weight: 700; background: linear-gradient(135deg, var(--gold), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .welcome-subtitle { font-size: 1.2rem; color: var(--text-dim); margin-bottom: 3rem; }
        .welcome-buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .welcome-btn { padding: 1rem 2rem; font-size: 1.1rem; border-radius: 12px; cursor: pointer; border: none; font-weight: 600; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .welcome-btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); color: white; }
        .welcome-btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5); }
        .welcome-btn-secondary { background: var(--bg-card); color: var(--text); border: 2px solid var(--border); }
        .welcome-btn-secondary:hover { border-color: var(--accent); background: var(--bg-hover); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 99999; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s; }
        .modal.active { opacity: 1; visibility: visible; pointer-events: all; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-dim); font-weight: 500; }
        .form-group input { width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.95rem; font-family: 'Inter', sans-serif; }
        .error, .success, .info { padding: 0.75rem; border-radius: 6px; margin: 1rem 0; display: none; }
        .error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); }
        .info { background: rgba(139, 92, 246, 0.1); border: 1px solid var(--accent); color: var(--accent); }
        .error.show, .success.show, .info.show { display: block; }
        .container { display: flex; height: calc(100vh - 70px); }
        .main-area { flex: 1; padding: 1rem; display: flex; flex-direction: column; }
        .tabletop { flex: 1; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .canvas-container { flex: 1; position: relative; background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg-dark) 100%); overflow: hidden; }
        #mainCanvas { display: block; cursor: grab; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-title">‚öîÔ∏è THE FRACTURED SKY</div>
            <div class="welcome-subtitle">Ultimate Virtual Tabletop v4.0 FIXED</div>
            <div class="welcome-buttons">
                <button class="welcome-btn welcome-btn-primary" onclick="showDMLogin()">üé≠ Create Room (DM)</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="showPlayerLogin()">üë§ Join Room (Player)</button>
                <button class="welcome-btn welcome-btn-secondary" id="rejoinDMBtn" style="display:none;" onclick="rejoinAsD M()">üîÑ Rejoin Last Session</button>
            </div>
            <p style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 0.75rem; color: var(--text-dim);">
                v4.0 FIXED - DM Reconnection Enabled
            </p>
        </div>
    </div>

    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üßô</div>
                <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);">Dungeon Master</div>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Wizard" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="FracturedSky2025!" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">LOGIN & CREATE ROOM</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üë§</div>
                <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);">Join as Player</div>
            </div>
            <form onsubmit="playerLogin(event)">
                <div class="form-group">
                    <label>YOUR NAME</label>
                    <input type="text" id="playerName" placeholder="Enter character name" required>
                </div>
                <div class="form-group">
                    <label>ROOM CODE</label>
                    <input type="text" id="roomCodeInput" placeholder="Paste full room code" required>
                </div>
                <div class="error" id="playerError">Connection failed</div>
                <div class="success" id="playerSuccess">Request sent! Waiting for DM approval...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">REQUEST TO JOIN</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="header">
        <div class="title">‚öîÔ∏è THE FRACTURED SKY</div>
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn" id="dmControlsBtn" onclick="alert('DM Panel - Original functionality')" style="display: none;">üé≠ DM Controls</button>
        </div>
    </div>

    <div class="container">
        <div class="main-area">
            <div class="tabletop">
                <div class="canvas-container">
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CORE FIX: DM Reconnection with Session Persistence
        let peer = null;
        let isDM = false;
        let myId = null;
        let myName = null;
        let roomCode = null;
        let connections = new Map();
        let gameState = {}; // Store game state
        let sessionTimeout = null;
        
        const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes
        const STORAGE_KEY_PREFIX = 'fracturedSky_';

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            checkForLastSession();
            console.log('‚úÖ VTT Ready with Reconnection Support!');
        }

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            const canvas = document.getElementById('mainCanvas');
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }

        // Check for last DM session on load
        function checkForLastSession() {
            const lastSession = localStorage.getItem(STORAGE_KEY_PREFIX + 'lastDMSession');
            if (lastSession) {
                try {
                    const session = JSON.parse(lastSession);
                    const timeSinceLastSeen = Date.now() - session.timestamp;
                    
                    if (timeSinceLastSeen < SESSION_TIMEOUT) {
                        document.getElementById('rejoinDMBtn').style.display = 'block';
                        document.getElementById('rejoinDMBtn').textContent = 
                            `üîÑ Rejoin Session (${Math.round((SESSION_TIMEOUT - timeSinceLastSeen) / 1000 / 60)} min left)`;
                    } else {
                        // Session expired
                        localStorage.removeItem(STORAGE_KEY_PREFIX + 'lastDMSession');
                        clearSessionData(session.sessionId);
                    }
                } catch (e) {
                    console.error('Failed to parse session:', e);
                }
            }
        }

        function rejoinAsDM() {
            const lastSession = localStorage.getItem(STORAGE_KEY_PREFIX + 'lastDMSession');
            if (!lastSession) {
                alert('No session found to rejoin');
                return;
            }

            try {
                const session = JSON.parse(lastSession);
                const sessionData = loadSessionData(session.sessionId);
                
                if (!sessionData) {
                    alert('Session data not found');
                    localStorage.removeItem(STORAGE_KEY_PREFIX + 'lastDMSession');
                    return;
                }

                isDM = true;
                myName = 'Dungeon Master';
                
                // Create peer with NEW ID (PeerJS doesn't allow ID reuse)
                peer = new Peer();
                
                peer.on('open', (newId) => {
                    myId = newId;
                    roomCode = newId;
                    
                    // Update session with new peer ID
                    session.sessionId = newId;
                    session.timestamp = Date.now();
                    localStorage.setItem(STORAGE_KEY_PREFIX + 'lastDMSession', JSON.stringify(session));
                    
                    // Restore game state
                    gameState = sessionData.gameState || {};
                    
                    // Update UI
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('dmControlsBtn').style.display = 'block';
                    
                    alert(`‚úÖ Reconnected!\n\nNEW Room Code: ${newId}\n\nShare this NEW code with players.\n\nYour game state has been restored!`);
                    
                    // Save session data with new ID
                    saveSessionData(newId, sessionData);
                    
                    // Setup connection listener
                    peer.on('connection', (conn) => setupConnection(conn));
                    
                    console.log('‚úÖ DM Reconnected with new ID:', newId);
                });

                peer.on('error', (err) => {
                    console.error('Reconnection error:', err);
                    alert('Failed to reconnect. Please create a new session.');
                });

            } catch (e) {
                console.error('Rejoin failed:', e);
                alert('Failed to rejoin session');
            }
        }

        function showDMLogin() {
            document.getElementById('dmModal').classList.add('active');
        }

        function closeDMModal() {
            document.getElementById('dmModal').classList.remove('active');
            document.getElementById('dmError').classList.remove('show');
        }

        function dmLogin(e) {
            e.preventDefault();
            const user = document.getElementById('dmUser').value;
            const pass = document.getElementById('dmPass').value;
            
            if (user === 'Wizard' && pass === 'FracturedSky2025!') {
                closeDMModal();
                createRoom();
            } else {
                document.getElementById('dmError').classList.add('show');
            }
        }

        function createRoom() {
            isDM = true;
            myName = 'Dungeon Master';
            
            peer = new Peer();
            
            peer.on('open', (id) => {
                myId = id;
                roomCode = id;
                
                // Save DM session
                const session = {
                    sessionId: id,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY_PREFIX + 'lastDMSession', JSON.stringify(session));
                
                // Initialize empty game state
                gameState = {
                    gridCells: {},
                    tokens: [],
                    fogGroups: {},
                    zoom: 1,
                    panX: 0,
                    panY: 0
                };
                
                // Save initial session data
                saveSessionData(id, { gameState, playerData: [] });
                
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('dmControlsBtn').style.display = 'block';
                
                alert(`‚úÖ Room Created!\n\nRoom Code: ${id}\n\nShare this code with players.\n\nYou can refresh and rejoin within 5 minutes!`);
                
                peer.on('connection', (conn) => setupConnection(conn));
                
                // Start session timeout
                startSessionTimeout();
                
                console.log('‚úÖ DM Room Created:', id);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                alert('Connection error: ' + err.type);
            });
        }

        function showPlayerLogin() {
            document.getElementById('playerModal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('playerModal').classList.remove('active');
        }

        function playerLogin(e) {
            e.preventDefault();
            myName = document.getElementById('playerName').value;
            const code = document.getElementById('roomCodeInput').value.trim();
            
            peer = new Peer();
            peer.on('open', (id) => {
                myId = id;
                const conn = peer.connect(code);
                
                conn.on('open', () => {
                    sendToPeer(conn, {
                        type: 'playerJoinRequest',
                        name: myName,
                        peerId: myId
                    });
                    
                    document.getElementById('playerSuccess').classList.add('show');
                    
                    setTimeout(() => {
                        closePlayerModal();
                        document.getElementById('welcomeScreen').classList.add('hidden');
                    }, 2000);
                });
                
                conn.on('data', (data) => handleMessage(conn, data));
                conn.on('error', (err) => {
                    document.getElementById('playerError').textContent = 'Connection failed: ' + err.type;
                    document.getElementById('playerError').classList.add('show');
                });
            });
        }

        function setupConnection(conn) {
            connections.set(conn.peer, { conn, name: 'Unknown', role: 'player', approved: false });
            
            conn.on('data', (data) => handleMessage(conn, data));
            conn.on('close', () => {
                connections.delete(conn.peer);
                updateSessionTimeout();
            });
        }

        function handleMessage(conn, data) {
            console.log('Message received:', data.type);
            // Basic message handling - extend as needed
        }

        function sendToPeer(conn, data) {
            try {
                conn.send(data);
            } catch (err) {
                console.error('Send error:', err);
            }
        }

        // Session Management Functions
        function saveSessionData(sessionId, data) {
            const key = STORAGE_KEY_PREFIX + 'session_' + sessionId;
            const sessionData = {
                ...data,
                timestamp: Date.now()
            };
            localStorage.setItem(key, JSON.stringify(sessionData));
        }

        function loadSessionData(sessionId) {
            const key = STORAGE_KEY_PREFIX + 'session_' + sessionId;
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        function clearSessionData(sessionId) {
            const key = STORAGE_KEY_PREFIX + 'session_' + sessionId;
            localStorage.removeItem(key);
        }

        function startSessionTimeout() {
            if (sessionTimeout) clearTimeout(sessionTimeout);
            
            sessionTimeout = setTimeout(() => {
                if (connections.size === 0 && isDM) {
                    // No players connected for 5 minutes - clear session
                    const lastSession = localStorage.getItem(STORAGE_KEY_PREFIX + 'lastDMSession');
                    if (lastSession) {
                        const session = JSON.parse(lastSession);
                        clearSessionData(session.sessionId);
                        localStorage.removeItem(STORAGE_KEY_PREFIX + 'lastDMSession');
                    }
                    console.log('Session timed out - data cleared');
                }
            }, SESSION_TIMEOUT);
        }

        function updateSessionTimeout() {
            // Restart timeout when last player leaves
            if (connections.size === 0 && isDM) {
                startSessionTimeout();
            } else if (connections.size > 0 && sessionTimeout) {
                // Cancel timeout if players are connected
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
        }

        // Update session timestamp on important actions
        function updateSession() {
            if (!isDM || !roomCode) return;
            
            const session = {
                sessionId: roomCode,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY_PREFIX + 'lastDMSession', JSON.stringify(session));
            
            saveSessionData(roomCode, {
                gameState,
                playerData: Array.from(connections.values()).map(c => ({
                    name: c.name,
                    role: c.role,
                    approved: c.approved
                }))
            });
        }

        // Call updateSession periodically to keep session alive
        setInterval(() => {
            if (isDM && roomCode) {
                updateSession();
            }
        }, 30000); // Every 30 seconds

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (isDM && roomCode) {
                updateSession();
            }
        });

        init();
    </script>
</body>
</html>
