<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractured Sky VTT v4.0 - FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0e1a; --bg-card: #151928; --bg-hover: #1f2537;
            --accent: #8b5cf6; --accent-secondary: #ec4899; --gold: #fbbf24;
            --text: #e5e7eb; --text-dim: #9ca3af; --border: rgba(139, 92, 246, 0.2);
            --success: #10b981; --danger: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); overflow: hidden; height: 100vh; user-select: none; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: relative; z-index: 100; }
        .title { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--gold), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { padding: 0.6rem 1.2rem; background: var(--bg-hover); border: 1px solid var(--border); color: var(--text); border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; font-family: 'Inter', sans-serif; }
        .btn:hover { background: var(--accent); border-color: var(--accent); transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); border: none; color: white; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .welcome-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%); display: flex; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.5s; }
        .welcome-screen.hidden { opacity: 0; pointer-events: none; }
        .welcome-content { text-align: center; padding: 3rem; }
        .welcome-title { font-family: 'Cinzel', serif; font-size: 4rem; font-weight: 700; background: linear-gradient(135deg, var(--gold), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .welcome-subtitle { font-size: 1.2rem; color: var(--text-dim); margin-bottom: 3rem; }
        .welcome-buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .welcome-btn { padding: 1rem 2rem; font-size: 1.1rem; border-radius: 12px; cursor: pointer; border: none; font-weight: 600; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .welcome-btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-secondary)); color: white; }
        .welcome-btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5); }
        .welcome-btn-secondary { background: var(--bg-card); color: var(--text); border: 2px solid var(--border); }
        .welcome-btn-secondary:hover { border-color: var(--accent); background: var(--bg-hover); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 99999; opacity: 0; visibility: hidden; pointer-events: none; transition: all 0.3s; }
        .modal.active { opacity: 1; visibility: visible; pointer-events: all; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-dim); font-weight: 500; }
        .form-group input { width: 100%; padding: 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.95rem; font-family: 'Inter', sans-serif; }
        .error, .success, .info { padding: 0.75rem; border-radius: 6px; margin: 1rem 0; display: none; }
        .error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); }
        .info { background: rgba(139, 92, 246, 0.1); border: 1px solid var(--accent); color: var(--accent); }
        .error.show, .success.show, .info.show { display: block; }
        .container { display: flex; height: calc(100vh - 70px); }
        .main-area { flex: 1; padding: 1rem; display: flex; flex-direction: column; }
        .tabletop { flex: 1; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .canvas-container { flex: 1; position: relative; background: radial-gradient(circle at center, #1a1f2e 0%, var(--bg-dark) 100%); overflow: hidden; }
        #mainCanvas { display: block; cursor: grab; width: 100%; height: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-title">‚öîÔ∏è THE FRACTURED SKY</div>
            <div class="welcome-subtitle">Ultimate Virtual Tabletop v4.0 FIXED</div>
            <div class="welcome-buttons">
                <button class="welcome-btn welcome-btn-primary" onclick="showDMLogin()">üé≠ Create Room (DM)</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="showPlayerLogin()">üë§ Join Room (Player)</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="showDMRejoinModal()">üîÑ Rejoin Session (DM)</button>
            </div>
            <p style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 0.75rem; color: var(--text-dim);">
                v4.0 FIXED - Session Persistence Enabled
            </p>
        </div>
    </div>

    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üßô</div>
                <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);">Dungeon Master</div>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Wizard" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="FracturedSky2025!" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">LOGIN & CREATE ROOM</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="dmRejoinModal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîÑ</div>
                <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);">Rejoin DM Session</div>
            </div>
            <form onsubmit="dmRejoin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmRejoinUser" placeholder="Wizard" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmRejoinPass" placeholder="FracturedSky2025!" required>
                </div>
                <div class="form-group">
                    <label>SESSION ID (from your last session)</label>
                    <input type="text" id="dmRejoinSessionId" placeholder="Paste your session ID here" required>
                    <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem;">üí° This is the Room Code you shared with players</p>
                </div>
                <div class="error" id="dmRejoinError">Invalid credentials or session not found</div>
                <div class="success" id="dmRejoinSuccess">Rejoining session...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">REJOIN SESSION</button>
                <button type="button" class="btn" onclick="closeDMRejoinModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üë§</div>
                <div style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--gold);">Join as Player</div>
            </div>
            <form onsubmit="playerLogin(event)">
                <div class="form-group">
                    <label>YOUR NAME</label>
                    <input type="text" id="playerName" placeholder="Enter character name" required>
                </div>
                <div class="form-group">
                    <label>ROOM CODE</label>
                    <input type="text" id="roomCodeInput" placeholder="Paste full room code" required>
                </div>
                <div class="error" id="playerError">Connection failed</div>
                <div class="success" id="playerSuccess">Request sent! Waiting for DM approval...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">REQUEST TO JOIN</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="header">
        <div class="title">‚öîÔ∏è THE FRACTURED SKY</div>
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            <div id="roomCodeDisplay" style="display: none; padding: 0.5rem 1rem; background: var(--bg-hover); border-radius: 8px; border: 1px solid var(--border); color: var(--gold); font-weight: 600; font-size: 0.9rem; cursor: pointer;" onclick="copyRoomCode()">Room: <span id="roomCodeText">----</span></div>
            <button class="btn" id="dmControlsBtn" onclick="alert('DM Panel - Full functionality in complete version')" style="display: none;">üé≠ DM Controls</button>
        </div>
    </div>

    <div class="container">
        <div class="main-area">
            <div class="tabletop">
                <div class="canvas-container">
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let peer = null, isDM = false, myId = null, myName = null, roomCode = null;
        let connections = new Map(), gameState = {}, sessionTimeout = null;
        const SESSION_TIMEOUT = 5 * 60 * 1000, STORAGE_KEY = 'fracturedSky_session_';

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('beforeunload', () => isDM && roomCode && saveSession());
            console.log('‚úÖ VTT Ready!');
        }

        function resizeCanvas() {
            const canvas = document.getElementById('mainCanvas'), container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }

        function showDMLogin() { document.getElementById('dmModal').classList.add('active'); }
        function closeDMModal() { document.getElementById('dmModal').classList.remove('active'); document.getElementById('dmError').classList.remove('show'); }
        function showDMRejoinModal() { document.getElementById('dmRejoinModal').classList.add('active'); }
        function closeDMRejoinModal() { document.getElementById('dmRejoinModal').classList.remove('active'); document.getElementById('dmRejoinError').classList.remove('show'); }
        function showPlayerLogin() { document.getElementById('playerModal').classList.add('active'); }
        function closePlayerModal() { document.getElementById('playerModal').classList.remove('active'); }

        function dmLogin(e) {
            e.preventDefault();
            if (document.getElementById('dmUser').value === 'Wizard' && document.getElementById('dmPass').value === 'FracturedSky2025!') {
                closeDMModal();
                createRoom();
            } else {
                document.getElementById('dmError').classList.add('show');
            }
        }

        function dmRejoin(e) {
            e.preventDefault();
            const user = document.getElementById('dmRejoinUser').value;
            const pass = document.getElementById('dmRejoinPass').value;
            const sessionId = document.getElementById('dmRejoinSessionId').value.trim();

            if (user !== 'Wizard' || pass !== 'FracturedSky2025!') {
                document.getElementById('dmRejoinError').textContent = 'Invalid credentials';
                document.getElementById('dmRejoinError').classList.add('show');
                return;
            }

            const sessionData = loadSession(sessionId);
            if (!sessionData) {
                document.getElementById('dmRejoinError').textContent = 'Session not found or expired (max 5 min)';
                document.getElementById('dmRejoinError').classList.add('show');
                return;
            }

            document.getElementById('dmRejoinSuccess').classList.add('show');
            
            setTimeout(() => {
                isDM = true;
                myName = 'Dungeon Master';
                peer = new Peer(sessionId);

                peer.on('open', (id) => {
                    myId = roomCode = id;
                    gameState = sessionData.gameState || {};
                    
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('dmControlsBtn').style.display = 'block';
                    document.getElementById('roomCodeDisplay').style.display = 'block';
                    document.getElementById('roomCodeText').textContent = id.substring(0, 12) + '...';
                    
                    closeDMRejoinModal();
                    alert(`‚úÖ Session Rejoined!\n\nRoom Code: ${id}\n\nGame state restored!\nSession will auto-clear in 5 min if idle.`);

                    peer.on('connection', setupConnection);
                    startSessionTimeout();
                    saveSession();
                    console.log('‚úÖ DM Rejoined:', id);
                });

                peer.on('error', (err) => {
                    if (err.type === 'unavailable-id') {
                        alert('‚ö†Ô∏è Session ID in use or expired.\n\nCreating new session with your saved data...');
                        createRoomWithData(sessionData.gameState);
                    } else {
                        alert('Connection error: ' + err.type);
                    }
                });
            }, 1000);
        }

        function createRoom(savedData = null) {
            isDM = true;
            myName = 'Dungeon Master';
            peer = new Peer();

            peer.on('open', (id) => {
                myId = roomCode = id;
                gameState = savedData || { gridCells: {}, tokens: [], fogGroups: {}, zoom: 1, panX: 0, panY: 0 };
                
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('dmControlsBtn').style.display = 'block';
                document.getElementById('roomCodeDisplay').style.display = 'block';
                document.getElementById('roomCodeText').textContent = id.substring(0, 12) + '...';
                
                alert(`‚úÖ Room Created!\n\nRoom Code: ${id}\n\nShare with players.\n\nYou can rejoin within 5 min after refresh!`);

                peer.on('connection', setupConnection);
                startSessionTimeout();
                saveSession();
                console.log('‚úÖ Room Created:', id);
            });

            peer.on('error', (err) => {
                console.error('Error:', err);
                alert('Connection error: ' + err.type);
            });
        }

        function createRoomWithData(data) {
            closeDMRejoinModal();
            createRoom(data);
        }

        function playerLogin(e) {
            e.preventDefault();
            myName = document.getElementById('playerName').value;
            const code = document.getElementById('roomCodeInput').value.trim();

            peer = new Peer();
            peer.on('open', (id) => {
                myId = id;
                const conn = peer.connect(code);
                
                conn.on('open', () => {
                    sendToPeer(conn, { type: 'playerJoinRequest', name: myName, peerId: myId });
                    document.getElementById('playerSuccess').classList.add('show');
                    setTimeout(() => {
                        closePlayerModal();
                        document.getElementById('welcomeScreen').classList.add('hidden');
                    }, 2000);
                });

                conn.on('data', (data) => handleMessage(conn, data));
                conn.on('error', (err) => {
                    document.getElementById('playerError').textContent = 'Connection failed: ' + err.type;
                    document.getElementById('playerError').classList.add('show');
                });
            });
        }

        function setupConnection(conn) {
            connections.set(conn.peer, { conn, name: 'Unknown', role: 'player', approved: false });
            conn.on('data', (data) => handleMessage(conn, data));
            conn.on('close', () => {
                connections.delete(conn.peer);
                updateSessionTimeout();
            });
        }

        function handleMessage(conn, data) {
            console.log('Message:', data.type);
        }

        function sendToPeer(conn, data) {
            try { conn.send(data); } catch (err) { console.error('Send error:', err); }
        }

        function saveSession() {
            if (!isDM || !roomCode) return;
            const data = {
                gameState,
                timestamp: Date.now(),
                playerData: Array.from(connections.values()).map(c => ({ name: c.name, role: c.role, approved: c.approved }))
            };
            localStorage.setItem(STORAGE_KEY + roomCode, JSON.stringify(data));
        }

        function loadSession(sessionId) {
            const data = localStorage.getItem(STORAGE_KEY + sessionId);
            if (!data) return null;
            
            const session = JSON.parse(data);
            const age = Date.now() - session.timestamp;
            
            if (age > SESSION_TIMEOUT) {
                localStorage.removeItem(STORAGE_KEY + sessionId);
                return null;
            }
            
            return session;
        }

        function startSessionTimeout() {
            if (sessionTimeout) clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(() => {
                if (connections.size === 0 && isDM && roomCode) {
                    localStorage.removeItem(STORAGE_KEY + roomCode);
                    console.log('Session expired');
                }
            }, SESSION_TIMEOUT);
        }

        function updateSessionTimeout() {
            if (connections.size === 0 && isDM) {
                startSessionTimeout();
            } else if (connections.size > 0 && sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode).then(() => {
                const elem = document.getElementById('roomCodeText');
                const old = elem.textContent;
                elem.textContent = '‚úì Copied!';
                setTimeout(() => elem.textContent = old, 2000);
            }).catch(() => alert('Room Code: ' + roomCode));
        }

        setInterval(() => isDM && roomCode && saveSession(), 30000);
        init();
    </script>
</body>
</html>
